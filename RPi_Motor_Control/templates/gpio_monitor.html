<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPIO Monitor - RPi Motor Control</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .gpio-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
        }

        .gpio-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .gpio-groups {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .gpio-group {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .gpio-group h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .pin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #6c757d;
            transition: all 0.3s ease;
        }

        .pin-item.active {
            border-left-color: #28a745;
            background: #e8f5e9;
        }

        .pin-item.output {
            border-left-color: #007bff;
        }

        .pin-item.input {
            border-left-color: #ffc107;
        }

        .pin-info {
            flex: 1;
        }

        .pin-number {
            font-weight: bold;
            color: #007bff;
            margin-right: 10px;
        }

        .pin-name {
            font-weight: 600;
            color: #333;
        }

        .pin-description {
            font-size: 0.85em;
            color: #666;
            margin-top: 4px;
        }

        .pin-value {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .value-badge {
            padding: 5px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .value-high {
            background: #28a745;
            color: white;
        }

        .value-low {
            background: #6c757d;
            color: white;
        }

        .pin-controls {
            display: flex;
            gap: 5px;
        }

        .btn-pin {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .btn-pin:hover {
            opacity: 0.8;
        }

        .btn-pin:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-high {
            background: #28a745;
            color: white;
        }

        .btn-low {
            background: #6c757d;
            color: white;
        }

        .btn-press {
            background: #007bff;
            color: white;
        }

        .refresh-controls {
            text-align: center;
            margin: 20px 0;
        }

        .refresh-controls button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s;
        }

        .btn-refresh {
            background: #007bff;
            color: white;
        }

        .btn-auto {
            background: #28a745;
            color: white;
        }

        .btn-auto.active {
            background: #dc3545;
        }

        .refresh-controls button:hover {
            opacity: 0.9;
        }

        .status-message {
            padding: 10px 20px;
            margin: 10px auto;
            max-width: 600px;
            border-radius: 5px;
            text-align: center;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .nav-buttons {
            text-align: center;
            margin: 20px 0;
        }

        .nav-buttons a {
            display: inline-block;
            padding: 10px 20px;
            margin: 0 10px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .nav-buttons a:hover {
            background: #5a6268;
        }

        .last-update {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="gpio-container">
        <div class="gpio-header">
            <h1>üîå GPIO Pin Monitor & Control</h1>
            <p>Real-time GPIO pin status and testing interface</p>
        </div>

        <div class="nav-buttons">
            <a href="/">‚Üê Back to Main</a>
            <a href="/engineer">Engineer Menu</a>
        </div>

        <div class="refresh-controls">
            <button id="refreshBtn" class="btn-refresh">üîÑ Refresh Now</button>
            <button id="autoRefreshBtn" class="btn-auto">‚ñ∂Ô∏è Auto Refresh (OFF)</button>
            <div class="last-update" id="lastUpdate">Last updated: Never</div>
        </div>

        <div id="statusMessage"></div>

        <div class="gpio-groups" id="gpioGroups">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let autoRefreshInterval = null;
        let socket = null;

        // Initialize WebSocket connection
        function initSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('WebSocket connected');
            });

            socket.on('gpio_update', function(data) {
                console.log('GPIO update:', data);
                refreshGPIO();
            });

            socket.on('button_pressed', function(data) {
                console.log('Button pressed:', data);
                showStatus(`Button ${data.name} pressed for ${data.duration}ms`, 'success');
                setTimeout(refreshGPIO, data.duration + 50);
            });
        }

        // Fetch and display GPIO status
        async function refreshGPIO() {
            try {
                const response = await fetch('/api/gpio/groups');
                const data = await response.json();

                if (response.ok) {
                    displayGPIOGroups(data);
                    updateLastUpdate();
                } else {
                    showStatus('Error: ' + (data.error || 'Failed to fetch GPIO status'), 'error');
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Display GPIO groups
        function displayGPIOGroups(groups) {
            const container = document.getElementById('gpioGroups');
            container.innerHTML = '';

            const groupTitles = {
                'motors': '‚öôÔ∏è Motor Outputs',
                'buttons': 'üîò Button Inputs',
                'switches': 'üîÄ Switches & Limits',
                'communication': 'üì° Communication Pins'
            };

            for (const [groupName, pins] of Object.entries(groups)) {
                if (pins.length === 0) continue;

                const groupDiv = document.createElement('div');
                groupDiv.className = 'gpio-group';
                
                const title = document.createElement('h3');
                title.textContent = groupTitles[groupName] || groupName;
                groupDiv.appendChild(title);

                pins.forEach(pin => {
                    const pinItem = createPinItem(pin);
                    groupDiv.appendChild(pinItem);
                });

                container.appendChild(groupDiv);
            }
        }

        // Create pin item HTML
        function createPinItem(pin) {
            const item = document.createElement('div');
            item.className = `pin-item ${pin.type.toLowerCase()} ${pin.is_active ? 'active' : ''}`;
            item.id = `pin-${pin.pin}`;

            const info = document.createElement('div');
            info.className = 'pin-info';
            info.innerHTML = `
                <div>
                    <span class="pin-number">GPIO ${pin.pin}</span>
                    <span class="pin-name">${pin.name}</span>
                </div>
                <div class="pin-description">${pin.description}</div>
            `;

            const valueDiv = document.createElement('div');
            valueDiv.className = 'pin-value';

            const badge = document.createElement('span');
            badge.className = `value-badge ${pin.value === 1 ? 'value-high' : 'value-low'}`;
            badge.textContent = pin.value_display;
            valueDiv.appendChild(badge);

            if (pin.can_write) {
                const controls = document.createElement('div');
                controls.className = 'pin-controls';

                if (pin.function === 'Button') {
                    const pressBtn = document.createElement('button');
                    pressBtn.className = 'btn-pin btn-press';
                    pressBtn.textContent = 'üëÜ Press';
                    pressBtn.onclick = () => simulateButtonPress(pin.pin, pin.name);
                    controls.appendChild(pressBtn);
                } else {
                    const highBtn = document.createElement('button');
                    highBtn.className = 'btn-pin btn-high';
                    highBtn.textContent = 'HIGH';
                    highBtn.disabled = pin.value === 1;
                    highBtn.onclick = () => writePin(pin.pin, 1);
                    controls.appendChild(highBtn);

                    const lowBtn = document.createElement('button');
                    lowBtn.className = 'btn-pin btn-low';
                    lowBtn.textContent = 'LOW';
                    lowBtn.disabled = pin.value === 0;
                    lowBtn.onclick = () => writePin(pin.pin, 0);
                    controls.appendChild(lowBtn);
                }

                valueDiv.appendChild(controls);
            }

            item.appendChild(info);
            item.appendChild(valueDiv);

            return item;
        }

        // Write to GPIO pin
        async function writePin(pin, value) {
            try {
                const response = await fetch('/api/gpio/write', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin, value })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus(data.message, 'success');
                    await refreshGPIO();
                } else {
                    showStatus('Error: ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Simulate button press
        async function simulateButtonPress(pin, name) {
            try {
                const response = await fetch('/api/gpio/button_press', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin, duration: 100 })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus(data.message, 'success');
                } else {
                    showStatus('Error: ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        // Update last update time
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `Last updated: ${now.toLocaleTimeString()}`;
        }

        // Toggle auto refresh
        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                btn.textContent = '‚ñ∂Ô∏è Auto Refresh (OFF)';
                btn.classList.remove('active');
            } else {
                autoRefreshInterval = setInterval(refreshGPIO, 500); // Refresh every 500ms
                btn.textContent = '‚è∏Ô∏è Auto Refresh (ON)';
                btn.classList.add('active');
                refreshGPIO();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initSocket();
            refreshGPIO();

            document.getElementById('refreshBtn').addEventListener('click', refreshGPIO);
            document.getElementById('autoRefreshBtn').addEventListener('click', toggleAutoRefresh);
        });
    </script>
</body>
</html>
